<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
    <meta http-equiv="Content-Security-Policy"
      content="
        default-src 'self';
        script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.tailwindcss.com https://unpkg.com;
        style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
        font-src 'self' https://fonts.gstatic.com;
        img-src 'self' blob: data:;
        connect-src 'self';
        frame-ancestors 'none';
      ">

  <title>檢驗成果表產生器 v1.92</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React & ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

 
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      
      document.addEventListener('contextmenu', (e) => {
        e.preventDefault();
      });

      
      document.addEventListener('keydown', (e) => {
        // F12
        if (e.key === 'F12' || e.keyCode === 123) {
          e.preventDefault();
          return false;
        }
        // Ctrl+Shift+I, Ctrl+Shift+J, Ctrl+Shift+C
        if (e.ctrlKey && e.shiftKey && ['I', 'J', 'C', 'i', 'j', 'c'].includes(e.key)) {
          e.preventDefault();
          return false;
        }
        
        if (e.ctrlKey && (e.key === 'U' || e.key === 'u')) {
          e.preventDefault();
          return false;
        }
      });
    });
  </script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&display=swap');

    .print-page,
    .print-page * {
      font-family: "Times New Roman", "UKai", "標楷體", "DFKai-SB", "Noto Serif TC", serif !important;
    }

    .print-page {
      width: 210mm;
      min-height: 296.5mm;
      margin: 0 auto 2rem auto;
      background: white;
      box-sizing: border-box;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      position: relative;
    }

    
    .form-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14pt; 
      line-height: 1;
    }
    .form-table td, .form-table th {
      border: 1px solid black;
      padding: 6px 8px;
      vertical-align: middle;
    }
    .form-table .thick-border {
      border: 2px solid black;
    }
    .form-table .no-border-top {
      border-top: none !important;
    }
    
    
    .photo-table {
      font-size: 12pt;
    }
    
    .check-box {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 1px solid black;
      margin-right: 4px;
      text-align: center;
      line-height: 12px;
      font-size: 10px;
      vertical-align: middle;
      position: relative;
      top: -1px;
    }
    .check-box.checked {
        background-color: black;
    }

    .symbol-box {
        font-family: "Times New Roman", serif;
        font-size: 16pt; 
        margin-right: 2px;
        vertical-align: middle;
        line-height: 1;
    }

    @media print {
      @page {
        size: A4;
        margin: 0; 
      }
      html, body {
        margin: 0 !important;
        padding: 0 !important;
        background: white;
      }
      nav, button, .no-print, .edit-mode-only, footer {
        display: none !important;
      }
      main {
        display: block !important;
        width: 100% !important;
        margin: 0 !important;
        padding: 0 !important;
      }
      .print-page {
        box-shadow: none;
        margin: 0 !important;
        height: 296.5mm !important;
        width: 210mm !important;
        page-break-after: always;
        break-after: page;
      }
      .print-page:last-of-type {
        page-break-after: auto !important;
        break-after: auto !important;
      }
      * {
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }
      .avoid-break {
        break-inside: avoid !important;
        page-break-inside: avoid !important;
      }
    }

    @media (max-width: 640px) {
      .print-page-wrapper { width: 100%; overflow-x: auto; padding: 0; }
      .print-page { min-width: 210mm; transform: scale(0.9); transform-origin: top left; margin-bottom: -30mm; }
    }
  </style>
</head>
<body class="bg-gray-100">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    const DESCRIPTION_OPTIONS = [
      "CLSM",
      "140kgf/cm2混凝土",
      "175kgf/cm2混凝土",
      "210kgf/cm2混凝土",
      "280kgf/cm2混凝土"
    ];

    const QTY_OPTIONS = [
      "1組2只",
      "1組3只"
    ];

    function getPhotoSpecificSuffix(index, baseType) {
      const pos = (index % 6) + 1;
      if (baseType === "CLSM") {
        switch(pos) {
          case 1: return "坍度cm";
          case 2: return "氯離子kg/cm3";
          case 3: return "取樣";
          case 4: return "取樣";
          case 5: return "28天抗壓";
          case 6: return "28天抗壓";
          default: return "";
        }
      } else {
        switch(pos) {
          case 1: return "坍度cm";
          case 2: return "氯離子kg/cm3";
          case 3: return "溫度℃";
          case 4: return "取樣";
          case 5: return "28天抗壓";
          case 6: return "28天抗壓";
          default: return "";
        }
      }
    }

    function toRocDateString(isoDate) {
      if (!isoDate || !isoDate.includes("-")) return "";
      const [y, m, d] = isoDate.split("-");
      const rocYearNum = parseInt(y, 10) - 1911;
      return `${rocYearNum}年${m}月${d}日`;
    }

    function toSimpleRocDate(isoDate) {
      if (!isoDate || !isoDate.includes("-")) return "";
      const [y, m, d] = isoDate.split("-");
      const rocYearNum = parseInt(y, 10) - 1911;
      return `${rocYearNum}.${m}.${d}`;
    }

    function getIsoDateOffset(offsetDays = 0) {
      const d = new Date();
      d.setDate(d.getDate() + offsetDays);
      return d.toISOString().split("T")[0];
    }

    const Icons = {
      Camera: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>,
      FileText: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>,
      Trash2: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>,
      Printer: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>,
      ArrowRight: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>,
      ChevronLeft: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="15 18 9 12 15 6"/></svg>,
      Edit: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>,
      ImageIcon: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>,
      Copy: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>,
      Wand: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M15 4V2"/><path d="M15 16v-2"/><path d="M8 9h2"/><path d="M20 9h2"/><path d="M17.8 11.8 19 13"/><path d="M15 9h0"/><path d="M17.8 6.2 19 5"/><path d="m3 21 9-9"/><path d="M12.2 6.2 11 5"/></svg>
    };

    function App() {
      const [view, setView] = useState("edit");
      const [photos, setPhotos] = useState([]);
      const [copySuccess, setCopySuccess] = useState(false);

      const [globalInfo, setGlobalInfo] = useState({
        title: "施工/檢驗照片",
        projectName: "臺中雲林水源調度-烏日至彰化送水管",
        supervisor: "台灣自來水股份有限公司中區工程處第一工務所及第三課",
        contractor: "澄翰實驗有限公司/盛河營造有限公司",
        defaultLocation: "環河路三段",
        defaultNodeStart: "9",
        defaultNodeEnd: "10",
        inspectionDate: getIsoDateOffset(0),
        photoDate: getIsoDateOffset(0),
        
        organizer: "台灣自來水股份有限公司中區工程處",
        reportNo: "",
        
        checkType: "inspection",
        defaultDescription: DESCRIPTION_OPTIONS[0],
        regulation: "契約規範及監造計畫書查驗試驗標準", 
        
        inspectorName: "", 
        contractorRep: "", 
        labName: "正道科技檢驗股份有限公司", 
        
        sampleQty: QTY_OPTIONS[0],
        
        testReportNo: "", 
        resultStatus: "合格",
        resultAction: "  ",
      });

      const fixedNotes = "1.各項工程使用材料設備及施工成品之試驗應由符合契約規定及依標準法授權之實驗室認證機構認可之實驗室辦理，並出具試驗報告。\n2.不符合或待改善者應填寫不符事項報告通知廠商提出矯正及預防措施，並實施追蹤管制。\n3.試驗報告、相片及相關文件資料等以附件方式附於本記錄表。";

      const handleInputChange = (e) => {
        const { name, value, type, checked } = e.target;
        setGlobalInfo((prev) => ({ 
            ...prev, 
            [name]: type === 'checkbox' ? checked : value 
        }));

        if (name === "defaultDescription") {
            setPhotos(prev => prev.map((p, idx) => {
                const suffix = getPhotoSpecificSuffix(idx, value);
                return { ...p, descriptionSuffix: `${value} ${suffix}` };
            }));
        }

        if (name === "photoDate" || name === "inspectionDate") {
            const isPhotoDateUpdate = name === "photoDate";
            setPhotos(prev => prev.map((p, idx) => {
                const pos = (idx % 6);
                if (isPhotoDateUpdate && pos < 4) {
                    return { ...p, dateIso: value, dateRoc: toSimpleRocDate(value) };
                } else if (!isPhotoDateUpdate && pos >= 4) {
                    return { ...p, dateIso: value, dateRoc: toSimpleRocDate(value) };
                }
                return p;
            }));
        }
      };

      const handlePhotoUpload = (e) => {
        const files = Array.from(e.target.files);
        if (!files.length) return;

        setPhotos((prev) => {
          const startIndex = prev.length;
          const newPhotos = files.map((file, idx) => {
            const absoluteIndex = startIndex + idx;
            const suffix = getPhotoSpecificSuffix(absoluteIndex, globalInfo.defaultDescription);
            const pos = (absoluteIndex % 6);
            
            const targetIsoDate = pos < 4 ? globalInfo.photoDate : globalInfo.inspectionDate;
            const targetRocDate = toSimpleRocDate(targetIsoDate);
            
            return {
                id: Date.now() + idx + Math.random(),
                fileObj: file,
                src: URL.createObjectURL(file),
                dateIso: targetIsoDate,
                dateRoc: targetRocDate,
                location: globalInfo.defaultLocation,
                nodeStart: globalInfo.defaultNodeStart,
                nodeEnd: globalInfo.defaultNodeEnd,
                descriptionSuffix: `${globalInfo.defaultDescription} ${suffix}`,
                projectName: globalInfo.projectName,
                projectNumber: absoluteIndex + 1
            };
          });
          return [...prev, ...newPhotos];
        });
        e.target.value = "";
      };

      const updatePhotoField = (id, field, value) => {
        setPhotos((prev) =>
          prev.map((p) => {
            if (p.id !== id) return p;
            if (field === "dateIso") {
              const newIso = value;
              const newRoc = toSimpleRocDate(newIso);
              return { ...p, dateIso: newIso, dateRoc: newRoc };
            }
            return { ...p, [field]: value };
          })
        );
      };

      const removePhoto = (id) =>
        setPhotos((prev) => {
          const filtered = prev.filter((p) => p.id !== id);
          return filtered.map((p, idx) => {
              const pos = (idx % 6);
              const targetIsoDate = pos < 4 ? globalInfo.photoDate : globalInfo.inspectionDate;
              return { 
                  ...p, 
                  projectNumber: idx + 1,
                  dateIso: targetIsoDate,
                  dateRoc: toSimpleRocDate(targetIsoDate)
              };
          });
        });

      const handlePrint = () => window.print();

      const rocInspectionDate = toSimpleRocDate(globalInfo.inspectionDate);
      const suggestedFilename = `${rocInspectionDate}-節點${globalInfo.defaultNodeStart}→節點${globalInfo.defaultNodeEnd}(${globalInfo.defaultDescription}).pdf`;

      const handleCopyFilename = () => {
        const textArea = document.createElement("textarea");
        textArea.value = suggestedFilename;
        document.body.appendChild(textArea);
        textArea.select();
        try {
            document.execCommand('copy');
            setCopySuccess(true);
            setTimeout(() => setCopySuccess(false), 2000);
        } catch (err) {
            console.error('Copy failed', err);
        }
        document.body.removeChild(textArea);
      };

      const chunkArray = (arr, size) => {
        const res = [];
        const copy = [...arr];
        while (copy.length) res.push(copy.splice(0, size));
        return res;
      };

      return (
        <div className="flex flex-col min-h-screen">
          <nav className="bg-blue-800 text-white p-4 shadow-md no-print sticky top-0 z-50">
            <div className="max-w-4xl mx-auto flex justify-between items-center gap-2">
              <h1 className="text-lg font-bold flex items-center gap-2">
                <Icons.Wand className="w-6 h-6" />
                檢驗成果表產生器 v1.92
              </h1>
              <div className="flex gap-2 mobile-center">
                {view === "edit" ? (
                  <button onClick={() => setView("preview")} className="bg-white text-blue-800 px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 hover:bg-blue-50 transition">
                    <Icons.FileText size={16} /> 預覽報告
                  </button>
                ) : (
                  <button onClick={() => setView("edit")} className="bg-white text-blue-800 px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 hover:bg-blue-50 transition">
                    <Icons.ChevronLeft size={16} /> 返回編輯
                  </button>
                )}
              </div>
            </div>
          </nav>

          <main className="flex-grow max-w-5xl mx-auto p-4 print:p-0 print:max-w-none w-full">
            {view === "edit" && (
              <div className="space-y-6">
                
                {/* 統一顏色：邊框 border-gray-200，標題文字 text-gray-700，標題底線 border-gray-100 */}
                <div className="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
                  <h2 className="text-xl font-bold mb-4 text-gray-700 flex items-center gap-2 border-b border-gray-100 pb-2">
                    <Icons.Edit size={20} /> 工程基本資料
                  </h2>
                  <div className="grid md:grid-cols-2 gap-4">
                    <div className="col-span-2">
                        <label className="block text-xs font-bold text-gray-500 mb-1">工程名稱</label>
                        <input type="text" name="projectName" value={globalInfo.projectName} onChange={handleInputChange} className="w-full p-2 border border-gray-300 rounded text-sm" />
                    </div>
                    <div>
                        <label className="block text-xs font-bold text-gray-500 mb-1">主辦機關</label>
                        <input type="text" name="organizer" value={globalInfo.organizer} onChange={handleInputChange} className="w-full p-2 border border-gray-300 rounded text-sm" />
                    </div>
                    <div>
                        <label className="block text-xs font-bold text-gray-500 mb-1">報告編號</label>
                        <input type="text" name="reportNo" value={globalInfo.reportNo} onChange={handleInputChange} placeholder="例：113-XXX" className="w-full p-2 border border-gray-300 rounded text-sm" />
                    </div>
                    <div className="col-span-2">
                        <label className="block text-xs font-bold text-gray-500 mb-1">監造單位</label>
                        <input type="text" name="supervisor" value={globalInfo.supervisor} onChange={handleInputChange} className="w-full p-2 border border-gray-300 rounded text-sm" />
                    </div>
                    <div className="col-span-2">
                        <label className="block text-xs font-bold text-gray-500 mb-1">承攬廠商</label>
                        <input type="text" name="contractor" value={globalInfo.contractor} onChange={handleInputChange} className="w-full p-2 border border-gray-300 rounded text-sm" />
                    </div>

                    <div className="col-span-1">
                      <label className="block text-xs font-bold text-gray-500 mb-1">說明內容</label>
                      <select name="defaultDescription" value={globalInfo.defaultDescription} onChange={handleInputChange} className="w-full p-2 border border-gray-300 rounded bg-white text-sm">
                        {DESCRIPTION_OPTIONS.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                      </select>
                    </div>
                    <div className="col-span-1">
                      <label className="block text-xs font-bold text-gray-500 mb-1">樣品數量</label>
                      <select name="sampleQty" value={globalInfo.sampleQty} onChange={handleInputChange} className="w-full p-2 border border-gray-300 rounded bg-white text-sm">
                        {QTY_OPTIONS.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                      </select>
                    </div>

                    <div className="col-span-2 md:col-span-1 space-y-3">
                        <div className="grid grid-cols-2 gap-4">
                            <div>
                               {/* 統一顏色：日期標籤 text-gray-500，邊框 border-gray-300 */}
                               <label className="block text-xs font-bold text-gray-500 mb-1">拍攝日期 (照片1-4)</label>
                               <input type="date" name="photoDate" value={globalInfo.photoDate} onChange={handleInputChange} className="w-full p-2 border border-gray-300 rounded text-sm" />
                            </div>
                            <div>
                               <label className="block text-xs font-bold text-gray-500 mb-1">會驗日期 (照片5-6)</label>
                               <input type="date" name="inspectionDate" value={globalInfo.inspectionDate} onChange={handleInputChange} className="w-full p-2 border border-gray-300 rounded text-sm" />
                            </div>
                        </div>
                        <div>
                           <label className="block text-xs font-bold text-gray-500 mb-1">依據規定</label>
                           <input type="text" name="regulation" value={globalInfo.regulation} onChange={handleInputChange} className="w-full p-2 border border-gray-300 rounded text-sm" />
                        </div>
                    </div>

                    <div className="col-span-2 md:col-span-1 space-y-3">
                        <div className="grid grid-cols-2 gap-2">
                           <div>
                             <label className="block text-xs font-bold text-gray-500 mb-1">監造人員 (會同簽章用)</label>
                             <input type="text" name="inspectorName" value={globalInfo.inspectorName} onChange={handleInputChange} className="w-full p-2 border border-gray-300 rounded text-sm" />
                           </div>
                           <div>
                             <label className="block text-xs font-bold text-gray-500 mb-1">廠商代表 (會同簽章用)</label>
                             <input type="text" name="contractorRep" value={globalInfo.contractorRep} onChange={handleInputChange} className="w-full p-2 border border-gray-300 rounded text-sm" />
                           </div>
                        </div>
                        <div>
                           <label className="block text-xs font-bold text-gray-500 mb-1">試驗單位/地點</label>
                           <input type="text" name="labName" value={globalInfo.labName} onChange={handleInputChange} className="w-full p-2 border border-gray-300 rounded text-sm" />
                        </div>
                    </div>
                  </div>
                </div>

                {/* 統一顏色：邊框 border-gray-200 (原黃色)，標題 text-gray-700 */}
                <div className="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
                  <h2 className="text-xl font-bold mb-4 text-gray-700 flex items-center gap-2 border-b border-gray-100 pb-2">
                    <Icons.FileText size={20} /> 檢驗結果紀錄
                  </h2>
                  <div className="grid md:grid-cols-3 gap-4">
                    <div>
                        <label className="block text-xs font-bold text-gray-500 mb-1">試驗報告編號</label>
                        <input type="text" name="testReportNo" value={globalInfo.testReportNo} onChange={handleInputChange} className="w-full p-2 border border-gray-300 rounded text-sm" />
                    </div>
                    <div>
                        <label className="block text-xs font-bold text-gray-500 mb-1">判定結果</label>
                        <select name="resultStatus" value={globalInfo.resultStatus} onChange={handleInputChange} className="w-full p-2 border border-gray-300 rounded text-sm">
                            <option value="合格">合格</option>
                            <option value="不合格">不合格</option>
                        </select>
                    </div>
                    <div>
                        <label className="block text-xs font-bold text-gray-500 mb-1">不符處置方式</label>
                        <input type="text" name="resultAction" value={globalInfo.resultAction} onChange={handleInputChange} className="w-full p-2 border border-gray-300 rounded text-sm" />
                    </div>
                  </div>
                </div>

                <div className="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
                  <div className="border-b border-gray-100 mb-4 pb-2">
                    <h2 className="text-xl font-bold text-gray-700 flex items-center gap-2">
                      <Icons.Camera size={20} /> 照片管理
                    </h2>
                    <p className="text-xs font-bold text-gray-500 mt-1 ml-8">
                      請依序上傳：1.坍度 2.氯離子 3.溫度/取樣 4.取樣 5.抗壓 6.抗壓
                    </p>
                  </div>

                    <div className="grid md:grid-cols-3 gap-4 mb-4">
                      <div>
                        <label className="block text-sm font-medium text-gray-500 mb-1">預設拍攝地點</label>
                        <input type="text" name="defaultLocation" value={globalInfo.defaultLocation} onChange={handleInputChange} className="w-full p-2 border border-gray-300 rounded" />
                      </div>
                      <div className="flex gap-2 items-end col-span-2">
                        <div className="flex-1">
                            <label className="block text-sm font-medium text-gray-500 mb-1">起點節點</label>
                            <input type="text" name="defaultNodeStart" value={globalInfo.defaultNodeStart} onChange={handleInputChange} className="w-full p-2 border border-gray-300 rounded text-center" />
                        </div>
                         <div className="pb-2 text-gray-400"><Icons.ArrowRight/></div>
                         <div className="flex-1">
                            <label className="block text-sm font-medium text-gray-500 mb-1">終點節點</label>
                            <input type="text" name="defaultNodeEnd" value={globalInfo.defaultNodeEnd} onChange={handleInputChange} className="w-full p-2 border border-gray-300 rounded text-center" />
                        </div>
                      </div>
                    </div>

                  <div className="flex justify-between items-center flex-wrap gap-2 mb-4">
                    <h3 className="font-bold text-gray-700">已上傳照片 ({photos.length})</h3>
                    <label className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg cursor-pointer flex items-center gap-2 shadow-sm transition">
                      <Icons.Camera size={18} /><span>新增照片</span>
                      <input type="file" accept="image/*" multiple className="hidden" onChange={handlePhotoUpload} />
                    </label>
                  </div>

                  <div className="space-y-4">
                    {photos.map((photo) => (
                      <div key={photo.id} className="border rounded-lg p-4 flex flex-col md:flex-row gap-4 bg-gray-50">
                        <div className="w-40 h-32 flex-shrink-0 bg-white border rounded overflow-hidden relative">
                           <img src={photo.src} className="w-full h-full object-cover" />
                           <button onClick={() => removePhoto(photo.id)} className="absolute top-1 right-1 bg-red-500 text-white p-1 rounded-full shadow hover:bg-red-600"><Icons.Trash2 size={14}/></button>
                        </div>
                        <div className="flex-grow grid grid-cols-2 gap-2 text-sm">
                           <div className="col-span-2 flex justify-between items-center mb-1">
                             <span className="font-bold bg-blue-100 text-blue-700 px-2 py-0.5 rounded">照片 #{photo.projectNumber}</span>
                           </div>
                           <input type="text" value={photo.location} onChange={(e)=>updatePhotoField(photo.id, "location", e.target.value)} className="border rounded p-1" placeholder="拍攝地點"/>
                           <div className="flex gap-1">
                             <input type="text" value={photo.nodeStart} onChange={(e)=>updatePhotoField(photo.id, "nodeStart", e.target.value)} className="border rounded p-1 w-full text-center" placeholder="起"/>
                             <span>→</span>
                             <input type="text" value={photo.nodeEnd} onChange={(e)=>updatePhotoField(photo.id, "nodeEnd", e.target.value)} className="border rounded p-1 w-full text-center" placeholder="止"/>
                           </div>
                           {/* 統一顏色：說明內容欄位移除 bg-yellow-50 */}
                           <input type="text" value={photo.descriptionSuffix} onChange={(e)=>updatePhotoField(photo.id, "descriptionSuffix", e.target.value)} className="border rounded p-1 col-span-2" placeholder="說明內容"/>
                           <input type="date" value={photo.dateIso} onChange={(e)=>updatePhotoField(photo.id, "dateIso", e.target.value)} className="border rounded p-1 col-span-2"/>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
                <div className="h-20"></div>
              </div>
            )}

            {view === "preview" && (
              <div className="flex flex-col items-center">
                <div className="w-full max-w-[210mm] mb-6 bg-yellow-50 border border-yellow-200 p-4 rounded-lg flex flex-col md:flex-row md:items-center md:justify-between no-print gap-3">
                  <div className="text-yellow-800 text-sm space-y-1 w-full md:w-auto">
                    <div><strong>提示：</strong>請點選下方「複製」按鈕複製檔名，點選「儲存/列印 PDF」後，將目的地設為「另存為 PDF」，並貼上檔名存檔。</div>
                    <div className="text-gray-800 flex flex-wrap items-center gap-2 mt-1">
                        <strong>建議檔名：</strong>
                        <span className="font-mono bg-white px-2 border rounded select-all break-all">{suggestedFilename}</span>
                        <button 
                            onClick={handleCopyFilename} 
                            className="text-blue-600 hover:text-blue-800 p-1 rounded hover:bg-blue-50 transition flex items-center gap-1 border border-blue-200"
                            title="複製檔名"
                        >
                            <Icons.Copy size={16} />
                            <span className="text-xs font-bold">複製</span>
                        </button>
                        {copySuccess && <span className="text-xs text-green-600 font-bold animate-pulse">已複製!</span>}
                    </div>
                  </div>
                  <button onClick={handlePrint} className="bg-green-600 text-white px-6 py-2 rounded-lg font-bold shadow-md hover:bg-green-700 flex items-center gap-2 transition whitespace-nowrap"><Icons.Printer size={20} /> 儲存/列印 PDF</button>
                </div>

                <div className="print-page-wrapper w-full flex flex-col items-center">
                  
                  {/* 第一頁：檢驗成果表 */}
                  <div className="print-page bg-white relative pt-[10mm] pb-[30mm] px-[22mm] text-[14pt]">
                      {/* Modification 1: Title font size 16pt, no bold */}
                      <h1 className="text-center mb-4 tracking-[0.5em] font-serif" style={{fontSize: '16pt', fontWeight: 'normal'}}>檢驗成果表</h1>
                      
                      <div className="flex justify-between font-serif text-[14pt] mb-1 px-1">
                        <div>編號：{globalInfo.reportNo}</div>
                        <div>會驗日期：{toRocDateString(globalInfo.inspectionDate)}</div>
                      </div>
                      
                      <table className="form-table thick-border">
                        <tbody>
                          {/* Modification 2: Set row height to 0.8cm for single line rows */}
                          <tr style={{height: "0.8cm"}}>
                            <td className="w-[22%] text-center">工程名稱</td>
                            <td colSpan="3">{globalInfo.projectName}</td>
                          </tr>
                          <tr style={{height: "0.8cm"}}>
                            <td className="text-center">主辦機關</td>
                            <td colSpan="3">{globalInfo.organizer}</td>
                          </tr>
                          <tr style={{height: "0.8cm"}}>
                            <td className="text-center">監造單位</td>
                            <td colSpan="3">{globalInfo.supervisor}</td>
                          </tr>
                          <tr style={{height: "0.8cm"}}>
                            <td className="text-center">承攬廠商</td>
                            <td colSpan="3">{globalInfo.contractor}</td>
                          </tr>
                          
                          <tr>
                            <td className="text-center">取樣/會驗項目</td>
                            <td colSpan="3">
                              <div className="flex items-center py-1">
                                  <span className="shrink-0 mr-4">
                                     <span className={globalInfo.checkType === 'sample' ? "check-box checked text-white" : "check-box"}></span>取樣
                                     <span className="ml-4"></span>
                                     <span className={globalInfo.checkType === 'inspection' ? "check-box checked text-white" : "check-box"}></span>查(會)驗
                                  </span>
                                  <span className="shrink-0">項目：<span>{globalInfo.defaultDescription}試體抗壓</span></span>
                              </div>
                            </td>
                          </tr>
                          
                          <tr style={{height: "0.8cm"}}>
                             <td className="text-center">依據規定</td>
                             <td colSpan="3">{globalInfo.regulation}</td>
                          </tr>
                          
                          <tr>
                            <td className="text-center">取樣/會驗地點</td>
                            <td colSpan="3">
                              <div className="flex items-center py-1">
                                  <span className="shrink-0 mr-4">
                                     <span className={globalInfo.checkType === 'sample' ? "check-box checked text-white" : "check-box"}></span>取樣
                                     <span className="ml-4"></span>
                                     <span className={globalInfo.checkType === 'inspection' ? "check-box checked text-white" : "check-box"}></span>會驗
                                  </span>
                                  <span className="shrink-0">地點：<span>{globalInfo.labName}</span></span>
                              </div>
                            </td>
                          </tr>
                          
                          <tr>
                            <td className="text-center">會同者</td>
                            <td colSpan="3">
                               <div className="flex">
                                 <span className="w-1/2">監造單位：<span>{globalInfo.inspectorName}</span></span>
                                 <span className="w-1/2">承攬廠商：<span>{globalInfo.contractorRep}</span></span>
                               </div>
                            </td>
                          </tr>
                          
                          <tr style={{height: "0.8cm"}}>
                            <td className="text-center">會驗日期</td>
                            <td colSpan="3">{toRocDateString(globalInfo.inspectionDate)}</td>
                          </tr>
                          
                          <tr style={{height: "0.8cm"}}>
                            <td className="text-center">樣品名稱</td>
                            <td>{globalInfo.defaultDescription}</td>
                            <td className="text-center">樣品數量</td>
                            <td>{globalInfo.sampleQty}</td>
                          </tr>
                          
                          <tr style={{height: "0.8cm"}}>
                             <td className="text-center">試驗單位</td>
                             <td colSpan="3">{globalInfo.labName}</td>
                          </tr>

                          <tr style={{height: "0.8cm"}}>
                            <td className="text-center">會驗時間</td>
                            <td colSpan="3">{toRocDateString(globalInfo.inspectionDate)}</td>
                          </tr>

                          <tr>
                            <td className="text-center">會驗者</td>
                            <td colSpan="3">
                               <div className="flex">
                                 <span className="w-1/2">監造單位：<span>{globalInfo.inspectorName}</span></span>
                                 <span className="w-1/2">承攬廠商：<span>{globalInfo.contractorRep}</span></span>
                               </div>
                            </td>
                          </tr>
                          
                          <tr>
                            <td className="text-center" style={{height: "100px"}}>檢驗結果</td>
                            <td colSpan="3" className="align-top relative p-2">
                               <div className="mb-2">檢驗情形：(紀錄檢驗數據及契約規定)</div>
                               <div className="mb-2">
                                  試驗報告編號: <span className="ml-2 font-bold">{globalInfo.testReportNo}</span>
                               </div>
                               <div className="flex items-center mb-2">
                                  <span className={globalInfo.resultStatus === "合格" ? "check-box checked text-white" : "check-box"}></span>
                                  <span className="mr-6">合 格</span>
                                  <span className={globalInfo.resultStatus === "不合格" ? "check-box checked text-white" : "check-box"}></span>
                                  <span>不合格</span>
                               </div>
                               <div>
                                  處理方式：<span>{globalInfo.resultAction}</span>
                               </div>
                            </td>
                          </tr>
                          
                          <tr>
                            <td className="text-center" style={{height: "100px"}}>備 註</td>
                            <td colSpan="3" className="align-top pt-2 whitespace-pre-wrap font-serif" style={{fontSize: '13pt'}}>
   {fixedNotes}
</td>
                          </tr>
                          
                          <tr>
                             <td className="text-center font-bold" colSpan="4">監 造 單 位</td>
                          </tr>
                        </tbody>
                      </table>
                      <table className="form-table no-border-top thick-border" style={{borderTop: 'none'}}>
                        <tbody>
                           <tr style={{height: "0.6cm"}}>
                              <td className="w-1/2 align-middle text-center font-bold no-border-top" style={{borderRight: '1px solid black', padding: '0'}}>
                                 查驗人員
                              </td>
                              <td className="w-1/2 align-middle text-center font-bold no-border-top" style={{padding: '0'}}>
                                 監造主管
                              </td>
                           </tr>
                           <tr style={{height: "3.5cm"}}>
                              <td className="w-1/2 text-center font-serif no-border-top" style={{borderRight: '1px solid black', paddingBottom: '0.5cm', verticalAlign: 'bottom'}}>
                                  年月日(請押日期)
                              </td>
                              <td className="w-1/2 text-center font-serif no-border-top" style={{paddingBottom: '0.5cm', verticalAlign: 'bottom'}}>
                                  年月日(請押日期)
                              </td>
                           </tr>
                        </tbody>
                      </table>
                  </div>

                  {/* 照片頁 */}
                  {photos.length > 0 && chunkArray(photos, 2).map((pagePhotos, pageIndex) => (
                    <div key={pageIndex} className="print-page bg-white shadow-2xl mb-8 relative">
                      <div className="text-center mb-2" style={{ paddingLeft: '30mm', paddingRight: '30mm', paddingTop: '10mm' }}>
                        <h1 className="text-2xl font-bold tracking-[0.5em] mb-4 font-serif">{globalInfo.title}</h1>
                        <div className="text-left space-y-1" style={{ fontSize: '14pt' }}>
                          <div className="flex"><span className="font-bold whitespace-nowrap shrink-0">監造單位：</span><span className="whitespace-nowrap">{globalInfo.supervisor}</span></div>
                          <div className="flex"><span className="font-bold whitespace-nowrap shrink-0">承攬廠商：</span><span className="whitespace-nowrap">{globalInfo.contractor}</span></div>
                        </div>
                      </div>

                      <div className="pb-8" style={{ paddingLeft: '30mm', paddingRight: '30mm' }}>
                        {pagePhotos.map((photo, index) => (
                          <div 
                              key={photo.id} 
                              className={`avoid-break photo-table border border-black text-sm relative ${index === 0 && pagePhotos.length > 1 ? 'border-b-0' : ''}`}
                              style={{ marginBottom: 0 }}
                          >
                            <div className="flex border-b border-black" style={{ height: "100mm" }}>
                              {/* Modification 3: Removed bg-gray-50 and changed p-2 to p-1 */}
                              <div className="flex-1 border-r border-black p-1 flex items-center justify-center">
                                {photo.src ? (
                                  <img src={photo.src} className="max-w-[98%] max-h-[98%] object-contain mx-auto" />
                                ) : (
                                  <div className="text-gray-300">無照片</div>
                                )}
                              </div>

                              <div className="flex flex-col leading-tight break-all shrink-0" style={{ width: "24.4mm", fontSize: '12pt' }}>
                                
                                <div className="flex-1 p-1 border-b border-black overflow-hidden flex flex-col justify-center">
                                  <span className="font-bold block">工程名稱：</span>
                                  <span className="block" style={{fontSize: '10pt'}}>{photo.projectName}</span>
                                </div>

                                <div className="p-1 border-b border-black flex flex-col justify-center" style={{ height: "15mm" }}>
                                  <span className="font-bold block">編號：</span>
                                  <span className="block">{photo.projectNumber}</span>
                                </div>
                                
                                <div className="p-1 border-b border-black flex flex-col justify-center" style={{ height: "15mm" }}>
                                  <span className="font-bold block">拍攝日期：</span>
                                  <span>{photo.dateRoc}</span>
                                </div>
                                
                                <div className="flex-1 p-1 border-b border-black overflow-hidden flex flex-col justify-center">
                                  <span className="font-bold block">地點：</span>
                                  <span className="block mb-1">{photo.location}</span>
                                  <span style={{fontSize: '10pt'}}>節點 {photo.nodeStart}→{photo.nodeEnd}</span>
                                </div>

                                <div style={{ height: "25mm" }}>
                                    {/* Space for stamp/signature */}
                                </div>

                              </div>
                            </div>

                            <div className="px-2 font-medium flex items-center" style={{ height: "10mm", fontSize: '12pt' }}>
                              <span className="font-bold mr-2">說明：</span>
                              節點 {photo.nodeStart}→{photo.nodeEnd} {photo.descriptionSuffix}
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </main>

          <footer className="no-print bg-white border-t border-gray-200 py-8">
            <div className="max-w-4xl mx-auto px-4 text-center">
              <p className="text-gray-400 text-xs tracking-widest uppercase font-serif">
                Copyright © 2025 RayL. All Rights Reserved.
              </p>
            </div>
          </footer>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
